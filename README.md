# WSO2 APIM + IS + Traefik stack

Production-ready docker-compose setup that runs WSO2 API Manager (APIM) and WSO2 Identity Server (IS) behind a Traefik v3 reverse proxy with automatic Let's Encrypt certificates and a shared MySQL 8.0 backend. The layout borrows the hardened configurations from the upstream [`docker-apim`](https://github.com/wso2/docker-apim) and [`docker-is`](https://github.com/wso2/docker-is) repositories, but keeps everything self-contained inside this folder.

## Components

- **Traefik** – terminates TLS, handles ACME/Let's Encrypt, and exposes the APIM and IS endpoints via SNI routing.
- **MySQL 8.0** – single instance that hosts the APIM (`WSO2AM_DB`, `WSO2AM_SHARED_DB`) and IS (`WSO2IS_IDENTITY_DB`, `WSO2IS_SHARED_DB`) schemas created via the bundled SQL scripts copied from the official WSO2 repos.
- **WSO2 API Manager** – defaults to `wso2/wso2am:4.5.0`, configured to sit behind Traefik and rely on MySQL.
- **WSO2 Identity Server** – defaults to `wso2/wso2is:7.1.0`, also configured for MySQL and exposed through Traefik.

## Prerequisites

- Docker Engine 24+ and Docker Compose plugin 2.20+.
- A domain with DNS records that point to the host running this stack (`am.example.com`, `api.example.com`, etc.). HTTP-01 validation requires public reachability on ports 80/443.
- Optional but recommended: a valid WSO2 subscription if you need the latest patched images from the private registry.

## Directory layout

```
WSO2_APIM_IS_Traefik/
├── config/
│   └── traefik/            # Static + dynamic Traefik config (TLS, serversTransport)
├── config/mysql/scripts/   # MySQL schema bootstrap SQL files from upstream repos
├── conf/                   # Generated WSO2 config (created by install.sh)
├── data/letsencrypt/       # ACME storage (acme.json)
├── templates/              # deployment.toml templates with placeholder tokens
├── docker-compose.yml      # Combined Traefik + MySQL + APIM + IS stack
├── .env.example            # Sample values for manual editing
└── install.sh              # Interactive helper that prepares .env and configs
```

## Quick start

1. **Clone and inspect**

	```bash
	cd WSO2_APIM_IS_Traefik
	ls
	```

2. **Run the installer** to capture your domain, Let's Encrypt email, image tags, and passwords. It writes `.env`, renders the APIM/IS `deployment.toml` files, and prepares `acme.json` with the correct permissions.

	```bash
	./install.sh
	```

	Edit `.env` or any generated config under `conf/` if you need to fine-tune values (e.g., switch to images hosted in `docker.wso2.com`).

3. **Start the stack**

	```bash
	docker compose up -d
	```

	The first boot takes a few minutes while MySQL initializes the schemas and WSO2 services perform their setup runs.

4. **Access the portals** (replace the hostnames with whatever you configured):

	- `https://am.example.com/publisher`, `https://am.example.com/devportal`, `https://am.example.com/admin`, `https://am.example.com/carbon`
	- `https://api.example.com` for the gateway endpoints (8243/8280 routed through Traefik).
	- `https://iam.example.com/console` and `https://iam.example.com/myaccount` for the Identity Server apps.
	- `https://traefik.example.com` for the Traefik dashboard (no auth by default—restrict at the DNS/firewall level or add basic auth labels if needed).

## Configuration flow

| Item | How it is set |
| ---- | ------------- |
| `.env` | Generated by `install.sh` (or copy from `.env.example`).
| `conf/apim/.../deployment.toml` | Rendered from `templates/apim/...` using the answers you provide to the installer.
| `conf/is/.../deployment.toml` | Rendered from `templates/is/...` with the same helper.
| `config/mysql/scripts/*.sql` | Direct copies from the upstream repos to guarantee schema compatibility.
| `config/traefik/*.yml` | Static files checked into this repo; edit if you need extra routers or middlewares.

## Operational tips

- **DNS & ACME**: make sure all hostnames resolve to the docker host *before* running `docker compose up`. Traefik requests certificates the first time each router receives traffic.
- **Schema upgrades**: when you bump APIM/IS versions, re-apply the latest SQL scripts from the official repos to keep in sync, and re-run `install.sh` if the templates changed.
- **External key manager**: this compose keeps APIM's built-in key manager. If you need APIM to delegate key management to the standalone IS instance, follow the WSO2 "APIM with IS as KM" guide and extend the supplied templates accordingly.
- **Backups**: persist `/var/lib/mysql` (handled via the `mysql-data` volume) and keep copies of `.env`, `conf/`, and `data/letsencrypt/acme.json` for disaster recovery.

## Cleanup

```
docker compose down --volumes
rm -f .env conf/apim/repository/conf/deployment.toml conf/is/repository/conf/deployment.toml data/letsencrypt/acme.json
```

> ⚠️ The cleanup command removes databases and configuration; run it only if you intend to reset the environment.
